/*
 * Tilekit
 *
 * Nate Hunzaker <nate.hunzaker@gmail.com>
 * http://natehunzaker.com
 *
 */

window.Tilekit={debug:!1},$.extend(window.Tilekit.prototype,new window.EventEmitter2),window.TK=window.Tilekit,Array.prototype.isArray=!0,Function.prototype.pulse=function(a,b,c){var d=this;this.__interval=setInterval(function(){d.apply(c||d,b)},a||1e3)},Number.prototype.roundTo=function a(a){if(this<a/2)return 0;var b=a*Math.round(this/a);return b===0&&(b=a),b},Number.prototype.floorTo=function(a){if(this<a)return 0;var b=a*Math.floor(this/a);return b===0&&(b=a),b},Number.prototype.ceilTo=function b(a){if(this<a)return a;var b=a*Math.ceil(this/a);return b===0&&(b=a),b},Number.prototype.times=function(a,b){if(this===0)return;var c=~~Math.abs(this),d=0;do a.apply(b||this,[d]),c--,d++;while(c>0)},String.prototype.trim=String.prototype.trim||function(){return this.replace(/^\s+|\s+$/g,"")},typeof window!="undefined"&&(window.requestAnimationFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a){window.setTimeout(a,1e3/60)}}()),Function.prototype.bind||(Function.prototype.bind=function(a){if(typeof this!="function")throw new TypeError("Function.prototype.bind - what is trying to be bound is not callable");var b=Array.prototype.slice.call(arguments,1),c=this,d=function(){},e=function(){return c.apply(this instanceof d?this:a,b.concat(Array.prototype.slice.call(arguments)))};return d.prototype=this.prototype,e.prototype=new d,e}),Math.percentChance=function(a,b){Math.random()<a/100&&b()},Math.parseDelta=function(a,b){return/\%/.test(a)?b*(parseFloat(a,10)/100):/\+|\-/.test(a)?b+parseFloat(a,10):a},function(){var a=window.Format={};a.align=function(a,b,c,d){return/bottom|right/ig.test(a)?c-d-b:d},typeof module!="undefined"?global.Format=a:window.Format=a}(),function(){var a={};a.toRadians=function(a){return a*(Math.PI/180)},a.findAngle=function(a,b){a.isArray&&(a={x:a[0],y:a[1]}),b.isArray&&(b={x:b[0],y:b[1]});var c=Math.atan2(b.y-a.y,b.x-a.x)*(180/Math.PI);return c<0?c+360:c},a.findPoint=function(b,c,d,e){e=e||100;var f=a.toRadians(d);return{x:b.x+c*~~(Math.cos(f)*e)/e,y:b.y+c*~~(Math.sin(f)*e)/e}},a.findDistance=function(a,b){var c=Math.pow(b.x-a.x,2),d=Math.pow(b.y-a.y,2),e=Math.sqrt(c+d);return e},a.isWithinCone=function(b,c,d,e,f){var g=a.findAngle(c,b),h=a.findDistance(b,c);return h>=d?!1:e-f>=g||g>=e+f?!1:!0},typeof module!="undefined"?global.Geo=a:window.Geo=a}();var Rectangle=function(a,b){var c=this,d=b.tileEngine;return $.extend(this,{x:0,y:0,stroke:null,fill:null,width:100,height:100},b),this.canvas=a,this.c=this.canvas.getContext("2d"),d&&d.on("refresh",function(){window.requestAnimationFrame(function(){c.draw()})}),this.draw=function(){var a=this.x,b=this.y;if(this.tile){var c=this.tileEngine,d=this.canvas,e=c.tile,f=c.get("size"),g=c.get("scroll"),h=d.width/2-f/2,i=d.height/2-f/2;a=this.tile.x*f,b=this.tile.y*f,a+=h-g.x*2,b+=i-g.y*2}this.fill&&(this.c.fillStyle=this.fill,this.c.fillRect(a,b,this.width,this.height)),this.stroke&&(this.c.strokeStyle=this.stroke,this.c.strokeRect(a,b,this.width,this.height))},this},TextBox=function(a){a=a||{},this.header=a.header||"???",this.subheader=a.subheader||!1,this.body=a.body||"",this.context=a.context,this.lineheight=a.lineheight||25};TextBox.prototype.setFont=function(a,b){var c=this.context;c.textBaseline="top",c.fillStyle=a,c.font=b},TextBox.prototype.drawWindow=function(){var a=this.context;a.fillStyle="#f0f0f0",a.fillRect(0,document.height-document.height*.2,document.width,document.height*.2),a.fillStyle="#333",a.fillRect(0,document.height-document.height*.2-2,document.width,2),a.fillStyle="#fff",a.fillRect(0,document.height-document.height*.2+1,document.width,1)},TextBox.prototype.drawText=function(a,b,c){this.context.fillText(a,document.width*.1+(b||0),document.height-document.height*.2+(c||0))},TextBox.prototype.drawEllipsis=function(){var a=this.context,b=document.width*.93,c=document.height-document.height*.05;a.fillStyle="#333",a.fillRect(b,c,5,5),a.fillRect(b+10,c,5,5),a.fillRect(b+20,c,5,5)},TextBox.prototype.draw=function(){var a=this.context,b=this;this.drawWindow(),this.setFont("black","bold 14pt monospace"),this.drawText(this.header,0,15),this.subheader&&(this.setFont("#666","normal 10pt monospace"),this.drawText(this.subheader,0,40)),this.setFont("#333","normal 14pt monospace");var c=0,d=this.body.split(" "),e=70,f=0,g="",h=0;while(d[f]){g=d[f],h=a.measureText(g+" ").width,c+h>document.width*.85&&(c=0,e+=this.lineheight);if(e>document.height*.2-document.height*.05)return;b.drawText(g,c,e),c+=a.measureText(g+" ").width,f++}this.drawEllipsis();return};var Timer=function(){this.date=new Date};Timer.prototype.update=function(){var a=new Date;this.date=a},Timer.prototype.getMilliseconds=function(){return this.date.getTime()},Timer.prototype.getSeconds=function(){return Math.round(this.date.getTime()/1e3)},function(a){var b=a.Sprite=function(a,b,c,d,e,f,g,h){this.spritesheet=null,this.offsetX=0,this.offsetY=0,this.width=b,this.height=c,this.frames=1,this.currentFrame=0,this.duration=1,this.posX=0,this.posY=0,this.shown=!0,this.zoomLevel=1,this.shadow=null,this.setSpritesheet(a),this.setOffset(d,e),this.setFrames(f),this.setDuration(g),this.target=h,this.timer=new window.Timer,this.created_at=Date.now();var i=new Date;this.duration>0&&this.frames>0?this.ftime=i.getTime()+this.duration/this.frames:this.ftime=0};b.prototype.setSpritesheet=function(a){return a instanceof Image?this.spritesheet=a:(this.spritesheet=new Image,this.spritesheet.src=a),this},b.prototype.setPosition=function(a,b){return this.posX=a,this.posY=b,this},b.prototype.setOffset=function(a,b){return this.offsetX=a,this.offsetY=b,this},b.prototype.setFrames=function(a){return this.currentFrame=0,this.frames=a,this},b.prototype.setDuration=function(a){return this.duration=a,this},b.prototype.nextFrame=function(){if(this.duration>0){var a=new Date;this.duration>0&&this.frames>0?this.ftime=a.getTime()+this.duration/this.frames:this.ftime=0,this.offsetX=this.width*this.currentFrame,this.currentFrame===this.frames-1?this.currentFrame=0:this.currentFrame++}return this},b.prototype.animate=function(a){return a=a||this.timer,a.update(),a.getMilliseconds()>this.ftime&&this.nextFrame(),this},b.prototype.draw=function(a,b,c){a=a||this.target;if(this.shown){if(b!==undefined&&b){if(this.shadow===null){var d=document.createElement("canvas"),e=d.getContext("2d");d.width=this.width,d.height=this.height,e.drawImage(this.spritesheet,this.offsetX,this.offsetY,this.width,this.height,0,0,this.width*this.zoomLevel,this.height*this.zoomLevel);var f=e.getImageData(0,0,d.width,d.height);for(var g=0,h=f.data.length;g<h;g+=4)f.data[g]=0,f.data[g+1]=0,f.data[g+2]=0;e.clearRect(0,0,d.width,d.height),e.putImageData(f,0,0),this.shadow=e}a.save(),a.globalAlpha=.1;var i=this.width*this.zoomLevel,j=this.height*this.zoomLevel;a.drawImage(this.shadow.canvas,this.posX,this.posY-j,i,j*2),a.restore()}a.drawImage(this.spritesheet,this.offsetX,this.offsetY,this.width,this.height,this.posX,this.posY,this.width*this.zoomLevel,this.height*this.zoomLevel)}return this}}(window.Tilekit),function(a){"use strict",a.Entity=window.klass({attributes:{},layers:{},initialize:function(a){this.attributes=$.extend(!0,this.attributes,a)},get:function(a){return this.attributes[a]},set:function(a,b){var c=this.attributes[a];return this.attributes[a]=b,this.emit(["change","change:"+b],b,c),this.attributes[a]},addLayer:function(a,b,c){if(!a)throw new Error("Entity#addLayer - Layer requires a namespace");if(typeof a=="object"){for(var d in a)a.hasOwnProperty(d)&&this.addLayer(d,a[d],c);return this}return this.layers[a]=b.bind(c||this),b},removeLayer:function(a){this.layers[a]&&delete this.layers[a]},renderLayers:function(a){var b=this.layers;for(var c in b)b.hasOwnProperty(c)&&typeof b[c]=="function"&&b[c].apply(this,[a||this.ctx,Date()])}}),$.extend(a.Entity.prototype,window.EventEmitter2.prototype)}(window.Tilekit),function(a){var b=Math.round;a.Tile=window.klass({x:0,y:0,width:32,height:32,layers:[],initialize:function(a){$.extend(this,a)},isTraversable:function(){return this.__blockOnce?(this.__blockOnce=undefined,!1):this.layers[1]===undefined||this.layers[1]===0},isBlocking:function(){return this.layers[1]>0}}),a.Tile.methods({roundedTile:function(){return{x:b(this.tile.x),y:b(this.tile.y)}}})}(window.Tilekit),function(a,b){"use strict";var c=b.Sprite,d=b.Tile,e=b.Entity,f=a.Geo,g=a.aStar,h=Math.floor,i=Math.ceil,j=Math.round,k=b.Grid=e.extend({attributes:{paused:!1,scroll:{x:0,y:0},size:32},initialize:function(c,d,e){var f=this;e=e||{},this.attributes=$.extend(!0,this.attributes,e,{created_at:Date.now()}),this.canvas=document.getElementById(c),this.ctx=this.canvas.getContext("2d"),this.tileset=d.tileset,this.encoding=e.encoding||24,b.debug&&this.addLayer("debug",function(a){var b=this.findCenter();a.drawImage(this.debug,b.x,b.y)}),this.on("ready",function(){e.autoResize!==!1&&$(a).resize(function(){f.fillspace()}).trigger("resize"),f.start_location&&f.panTo(e.start_location),f.begin()}),$(this.canvas).on("click mousemove mousedown mouseup",function(a){var b=f.get("size"),c=f.findCenter();a.tile=f.getTileAt(a.offsetX,a.offsetY),a.position={x:a.tile.x*b+c.x,y:a.tile.y*b+c.y},f.emit(a.type,a)}),this.start_location=e.start_location,this.portals=e.portals||[];var g=function(){f.emit("portal",j)};for(var h=0,i=this.portals.length;h<i;h++){var j=this.portals[h];this.on("tile:"+[j.x,j.y].join(","),g)}var k=this.base=document.createElement("canvas");this.baseCtx=k.getContext("2d");var l=this.staging=document.createElement("canvas");this.stagingCtx=l.getContext("2d");var m=this.debug=document.createElement("canvas");this.debugCtx=m.getContext("2d");var n=this.overlay=document.createElement("canvas");this.overlayCtx=n.getContext("2d"),k.height=m.height=l.height=n.height=e.canvasHeight||2e3,k.width=m.width=l.width=n.width=e.canvasWidth||2e3,this.generateTilemap(d.data)}});k.prototype.zoom=function(a){this.scale=a/100,this.c.scale(this.scale,this.scale)},k.methods({toJSON:function(){return{name:this.name,tileset:this.tileset,data:this.encode(),start_x:this.start_location.x,start_y:this.start_location.y}},encode:function(a){var b=this,c="",d;a=a||this.tilemap;for(var e=0,f=a.length;e<f;e++)d=a[e],d.isArray?d[0].isArray&&e!==0?c+="."+b.encode(d):c+="\n"+b.encode(d):c+=d<b.encoding?"0"+d.toString(b.encoding):d.toString(b.encoding);return c.trim()},isBlocking:function(a){return this.tilemap[a.y][a.x].isBlocking()}}),k.methods({begin:function m(){return this.paused?!1:(a.requestAnimationFrame(this.begin.bind(this)),m.then=m.then||this.created_at,m.now=Date.now(),this.set("fps",1e3/(m.now-m.then)),this.shift=60/(1e3/(m.now-m.then)),m.then=m.now,this.draw())},pause:function(){this.paused=!0},play:function(){this.paused=!1,this.begin()},save:function(){this.baseCtx.save(),this.debugCtx.save(),this.overlayCtx.save()}}),k.methods({generateTilemap:function(e){var f=this,g=this.get("size"),h;this.tileSprite=new c(this.tileset,g,g,0,0,this.stagingCtx);var i=new a.Image;i.src=this.tileset,i.onload=function(){f.tilesetDepth=i.width/g,f.tilemap=[];var a=e.trim().split("."),c=f.findCenter();for(var j=0;a[j];j++)for(var k=0,l=a[j].trim().split("\n");l[k];k++){f.tilemap[k]=f.tilemap[k]||[];for(var m=0,n=[],o=l[k].trim();o[m];m+=2){h=parseInt(o.slice(m,m+2),f.encoding);var p=f.tilemap[k][m/2]=f.tilemap[k][m/2]||new d({x:m/2,y:k,width:g,height:g,layers:[0,0,0]});f.tilemap[k][m/2].layers[j]=h,c=f.calculateTileOffset(h);var q=g*m/2,r=g*k;f.tileSprite.setOffset(c.x,c.y),f.tileSprite.setPosition(q,r),f.tileSprite.draw(f.baseCtx),j>1&&h>0&&f.tileSprite.draw(f.overlayCtx),b.debug&&j===1&&h>0&&(f.debugCtx.fillStyle="rgba(200, 100, 0, 0.4)",f.debugCtx.fillRect(q,r,g,g)),b.debug&&j>1&&h>0&&(f.debugCtx.fillStyle="rgba(250, 256, 0, 0.4)",f.debugCtx.fillRect(q,r,g,g))}}f.save(),f.drawPortals(),f.emit("ready")}}}),k.methods({findCenter:function(){var a=this.get("size"),b=this.get("scroll");return{x:this.canvas.width/2-a/2-b.x*2,y:this.canvas.height/2-a/2-b.y*2}},translateCoordinates:function(a,b){var c=this.get("size"),d=Math.ceil(a/c),e=Math.ceil(b/c);return{col:d,row:e}},getTileAt:function(a,b){var c=this.get("size"),d=this.get("scroll");return a=this.canvas.width-(this.canvas.width-a),b=this.canvas.height-(this.canvas.height-b),a-=this.canvas.width/2-c/2-d.x*2,b-=this.canvas.height/2-c/2-d.y*2,{x:a.floorTo(c)/c,y:b.floorTo(c)/c}},calculateTileOffset:function(a){var b=this.get("size"),c=this.tilesetDepth,d={x:0,y:h(a/c)*b};return d.x=a>c-1?a%c:a,d.x*=b,d},calculatePixelOffset:function(a){var b=this.findCenter(),c=this.get("size");return{x:a.x*c+b.x,y:a.y*c+b.y}}}),k.methods({fillspace:function(){var a=this.get("size");return this.canvas.width=document.width.roundTo(a),this.canvas.height=document.height.roundTo(a),this},replaceTile:function(a,b,c,e){var f=this.get("size");this.tilemap[b]||(this.tilemap[b]=[],this.tilemap[b][a]=new d(a,b,f,f)),this.tilemap[b][a][c]=e,this.drawTile({x:a,y:b})},clear:function(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.stagingCtx.clearRect(0,0,this.staging.width,this.staging.height)},panTo:function(a){if(!a)return b.debug&&console.error("Coordinates must be specified for panning."),this;var c=this.get("size")/2;return this.set("scroll",{x:a.x*c,y:a.y*c}),this},drawTile:function(a,b){a=a.roundedTile();var c=this,d=this.get("size"),e=c.findCenter(),f=b||0,g=c.tileSprite,h=this.tile.layers,i,j;g.setPosition(a.x*d,a.y*d),this.baseCtx.clearRect(a.x*d,a.y*d,d,d);do h[f][a.y]||(h[f][a.y]=[]),j=h[f],i=this.calculateTileOffset(j),g.setOffset(i.x,i.y),g.draw(this.baseCtx),f++;while(h[f])},drawPortals:function(){var a=this.debugCtx,b=this.get("size");this.start_location&&(a.strokeStyle="rgb(255, 180, 10)",a.fillStyle="rgba(255, 180, 10, 0.5)",a.fillRect(this.start_location.x*b,this.start_location.y*b,b,b),a.strokeRect(this.start_location.x*b,this.start_location.y*b,b,b));for(var c=0;c<this.portals.length;c++)a.strokeStyle="rgb(200, 20, 250)",a.fillStyle="rgba(200, 20, 250, 0.4)",a.fillRect(this.portals[c].x*b,this.portals[c].y*b,b,b),a.strokeRect(this.portals[c].x*b,this.portals[c].y*b,b,b)},draw:function(){var a=this.ctx,b=this.findCenter(),c=this.layers;return this.clear(),this.stagingCtx.drawImage(this.base,0,0),this.stagingCtx.save(),this.emit("refresh"),a.drawImage(this.staging,b.x,b.y),a.drawImage(this.overlay,b.x,b.y),this.renderLayers(a),!0}}),k.methods({plotCourse:function(a,b,c){var d={},e=this.tilemap;for(var h in c)if(c.hasOwnProperty(h)){var i=c[h].tile();d[h]=e[i.y][i.x].layers[1],e[i.y][i.x].layers[1]=1}var j=g(e,[a.x,a.y],[b.x,b.y]),k=[];for(var l=0,m=j.length,n;l+1<m;l++)n=f.findAngle(j[l],j[l+1]),n===90?n=270:n===270&&(n=90),k.push(n);for(var o in c)if(c.hasOwnProperty(o)){var p=c[o].tile();e[p.y][p.x].layers[1]=d[o]}return k}})}(window,window.Tilekit),function(a){"use strict";var b=Math.round,c=Math.abs,d=Math.PI,e=window.Geo,f=e.findDistance,g=e.isWithinCone,h=window.requestAnimationFrame,i=a.Sprite,j=a.Unit=a.Entity.extend({attributes:{speed:1,face:270,hearing:64,vision:96,visionCone:30,position:{x:0,y:0}},layers:{},isUnit:!0,tile:function(){var a=this.grid.get("size"),b=this.get("position");return{x:b.x/a,y:b.y/a}},initialize:function(b,c,f){var g=c.grid,h=g.get("size"),j=this;this.scene=c,this.grid=c.grid,this.ctx=c.grid.stagingCtx,this.set("position",{x:f.tile.x*h,y:f.tile.y*h}),this.sprite=new i(f.image,h,h,0,0,3,200,this.ctx),g.on("refresh",this.draw.bind(this),this),this.on("draw",function(){j.renderLayers(j.ctx)}),this.attributes=$.extend(!0,{name:b,created_at:Date.now()},this.attributes,f),this.layers=$.extend({},this.layers),a.debug&&this.addLayer({renderClipping:function(){var a=this.grid.get("size"),b=this.get("position");this.ctx.lineWidth=1,this.ctx.fillStyle="rgba(50, 255, 200, 0.3)",this.ctx.strokeStyle="rgba(50, 255, 200, 0.3)",this.ctx.fillRect(b.x,b.y,a,a),this.ctx.strokeRect(b.x,b.y,a,a)},renderVision:function(){var a=this.ctx,b=this.grid.get("size"),c=this.get("position"),d=c.x+b/2,f=c.y+b/2,g=this.get("vision"),h=this.get("face"),i=this.get("visionCone");if(!g)return;a.fillStyle="rgba(0, 100, 200, 0.3)",a.strokeStyle="rgba(0, 100, 200, 0.5)",a.lineWidth=1,a.beginPath(),a.moveTo(d,f),a.arc(d,f,g,e.toRadians(-h-i),e.toRadians(-h+i),!1),a.closePath(),a.stroke(),a.fill()},renderHearing:function(a){var b=this.grid.get("size"),c=this.get("position"),e=this.get("hearing"),f=c.x,g=c.y+b/2;if(!e)return;a.fillStyle="rgba(255, 150, 50, 0.4)",a.strokeStyle="rgba(255, 150, 50, 0.8)",a.lineWidth=1,a.beginPath(),a.arc(f,g,e,0,d*2),a.closePath(),a.stroke(),a.fill()}})}});j.methods({getTileFront:function(a){return e.findPoint(this.tile,a||1,this.get("face"))},getTileBack:function(a){return e.findPoint(this.tile,a||1,-this.get("face"))},setFace:function(b){if(typeof b!="number")return a.debug&&console.error("Unit#setFace requires a numerical direction."),!1;var d=b.isUnit?c(b.get("face")-180):b;switch(b){case 90:this.sprite.setOffset(0,100);break;case 270:this.sprite.setOffset(0,0);break;case 0:this.sprite.setOffset(0,150);break;case 180:this.sprite.setOffset(0,50)}return this.set("face",d),this}}),j.methods({toJSON:function(){return $.extend({},this.attributes,this.tile())},remove:function(){this.grid.removeListener("refresh",this.draw)}}),j.methods({draw:function(){var a=this.get("position");this.sprite.setPosition(a.x,a.y).draw(),this.emit("draw")}}),j.methods({halt:function(a){var b=this.grid.get("size"),c=this.get("position");this.moving=!1,this.set("position",{x:c.x.roundTo(b),y:c.y.roundTo(b)});var d=this.tile();this.sprite.currentFrame=0,a&&(this.grid.emit("tile:"+d.x+","+d.y),this.grid.emit("tile:*,"+d.y),this.grid.emit("tile:"+d.x+",*"))},move:function(a,c,d){function o(){var a=l.get("position");return l.set("position",{x:a.x+m.x*g*j,y:a.y+m.y*g*j}),c&&f.panTo(l.tile()),a.x===n.x&&a.y===n.y?(l.halt(!0),d.apply(l,[Date.now()])):(l.sprite.animate(),h(o))}if(this.moving)return!1;this.moving=!0,d=d||function(){},this.setFace(a);var f=this.grid,g=b(this.grid.shift),i=f.get("size"),j=this.get("speed"),k=this.get("position"),l=this,m=e.findPoint({x:0,y:0},1,-a),n=e.findPoint(k,i,-a);return this.detectHit(m.x*i,m.y*i)?this.halt(!0):(o(),this)},setPath:function(a,c){function i(){var a=h.shift();a!==undefined&&d.move(a,c.pan,i)}c=c||{};var d=this,e=[],f=this.grid,g=this.tile();a.isUnit&&(a=a.tile),g={x:b(g.x),y:b(g.y)},e=f.plotCourse(g,a,this.scene.units);var h=this.set("path",e);i()},detectHit:function(a,b){var c=this.scene.units,d=this.grid,e=d.get("size"),h=this.get("position"),i=this.tile(),j=this.get("name").toLowerCase(),k=!1,l={x:h.x+(a||0),y:h.y+(b||0)},m={x:l.x/e,y:l.y/e};d.isBlocking(m)&&(this.emit("blocked",m),k=!0);for(var n in c)if(c.hasOwnProperty(n)&&c[n]!==this){var o=c[n],p=o.get("position"),q=f(l,p)-e/2,r=o.get("vision")||0,s=o.get("visionCone")||0,t=o.get("hearing")||0,u=o.get("face");g(p,l,r,u,s)&&o.emit(["see","see:"+j],this),t>q&&o.emit(["hear","hear"+j],this);if(e>q+e){var v=o.get("name").toLowerCase();this.emit(["collision","collision:"+v],o),o.emit(["collision","collision:"+j],this),k=!0}}return k}})}(window.Tilekit),function(a){var b=a.Character=a.Unit.extend({attributes:{comment:"",emote:"",speed:2,face:270,hearing:64,vision:96,visionCone:30},showName:!1,initialize:function(b,c,d){this.supr(b,c,d);var e=c.grid.get("size");this.emote_sprite=new a.Sprite("/assets/emotes.png",e,e,0,0)},layers:{emote:function(){var a=this.emote_sprite,b=this.get("position"),c=this.grid.get("size"),d={surprised:[0,0],sad:[32,0],love:[64,0],power:[96,0],happy:[128,0],disguise:[160,0],poison:[0,32],quest:[32,32],idea:[64,32],see:[0,64],hear:[32,64]}[this.get("emote")]||!1;if(!d)return!1;a.setPosition(b.x,b.y-(c+Math.cos(Date.now()/500)*2)),a.setOffset(d[0],d[1]),a.draw(this.ctx)},renderName:function(){if(!this.showName)return;var a=this.ctx,b=this.get("name");a.font="15px monospace",a.fillStyle="#000";var c=this.ctx.measureText(b).width;a.fillText(b,this.tile.x*32-c/10,this.tile.y*31)}}})}(window.Tilekit),function(a){var b=a.Character,c=window.Textbox,d=a.Scene=window.klass(function(a){a=a||{},$.extend(this,{grid:!1,units:[]},a),this.add(a)});d.prototype.add=function(a){var c=0,d;if($.isArray(a)){while(a[c])d=a[c],d.tile=d.tile||{x:d.x||0,y:d.y||0},this.add(d),c++;return}return a=$.extend({},{image:"/assets/players/default.png",tile:{x:a.x||0,y:a.y||0}},a),d=this.units[a.name]=new b(a.name,this,a),d},d.prototype.remove=function(a){if(!this.units[a])return;this.units[a].remove(),delete this.units[a]},d.prototype.message=function(a,b,d){var e=this.grid;d=d||function(){},this.grid.addLayer("message",function(d,f){var g=new c({header:a,subheader:(new Array(a.length+3)).join("-"),body:b,context:e.c});g.draw.apply(g)}),$(window).one("keydown",function(a){return e.removeLayer("message"),d(a),!1})},d.prototype.find=function(a){var b;for(var c in this.units)if(a(this.units[c]))return b;return!1},d.prototype.findAt=function(a,b){var c;for(var d in this.units){c=this.units[d].tile;if(a.x===c.x&&a.y===c.y)if(b)b(this.units[d]);else return this.units[d]}},d.prototype.fetch=function(a,b){return $.get(a,function(a){b(a)}),{then:function(a){b=a}}}}(window.Tilekit);